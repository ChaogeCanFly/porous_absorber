<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
<link rel="stylesheet" href="styles/normalize.css">
<link rel="stylesheet" href="styles/style.css">

<title>Porous Absorber Calculator</title>

<script src="/js/utils.js"></script>
<script src="/js/config.js"></script>
<script type="module">
// Get reference to the JavaScript wrapper function generated by wasm-pack
import init, {rb_porous_absorber} from '/pkg/porous_absorber_calculator.js'
    
// Make the JavaScript wrapper function accessible to coding outside this module
window.rb_porous_absorber    = rb_porous_absorber
window.slotted_panel         = idiot
window.perforated_panel      = idiot
window.microperforated_panel = idiot
window.configuration         = idiot
    
async function wasm_start() {
  await init()
  console.log("WASM module initialisation complete...")
}

wasm_start()
</script>

<script>
const openTab = (evt, tabName) => {
  // Hide all elements with class="tabcontent"
  for (var tab of document.getElementsByClassName("tabcontent")) {
    tab.style.display = "none"
  }

  // Remove "active" from all elements with class="tablinks"
  for (var tablink of document.getElementsByClassName("tablinks")) {
    tablink.className = tablink.className.replace(" active", "")
  }

  // Make the selected tab button active
  evt.currentTarget.className += " active"

  // Fetch tab content from server
  document.getElementById(tabName).style.display = "block"

  var req = new XMLHttpRequest()

  req.open('GET',`/tabs/${tabName}.html`)

  req.onload = () => {
    document.getElementById(tabName).innerHTML = ""
    document.getElementById(tabName).insertAdjacentHTML('afterbegin', req.response)
    update_screen(tabName)
  }

  req.send()
}

// This function must be called everytime an input value is changed
const update_screen = tabName => {
  // Perform any unit conversions that might be needed
  tabConfig[tabName].map(show_and_convert_units)

  // Extract the input field values relevant for this tab
  let current_field_values = tabConfig[tabName].map(field => field.fetch(field.id))

  // WASM does its magic...
  let wasm_response = window[tabName].apply(null, current_field_values) || "Ok"

  // Did it work?
  if (wasm_response !== "Ok") {
    console.log(JSON.stringify(wasm_response, null, 2))
  }
}
</script>
</head>

<body>
<!-- Tabs -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'rb_porous_absorber')">Rigid Backed Porous Absorber</button>
  <button class="tablinks" onclick="openTab(event, 'slotted_panel')">Slotted Panel</button>
  <button class="tablinks" onclick="openTab(event, 'perforated_panel')">Perforated Panel</button>
  <button class="tablinks" onclick="openTab(event, 'microperforated_panel')">Microperforated Panel</button>
  <button class="tablinks" onclick="openTab(event, 'configuration')">Configuration</button>
</div>

<!-- Tab content -->
<div id="rb_porous_absorber"    class="tabcontent"></div>
<div id="perforated_panel"      class="tabcontent"></div>
<div id="slotted_panel"         class="tabcontent"></div>
<div id="microperforated_panel" class="tabcontent"></div>
<div id="configuration"         class="tabcontent"></div>
</body>
</html>